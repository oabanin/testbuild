var Z=Object.defineProperty;var J=(d,l,r)=>l in d?Z(d,l,{enumerable:!0,configurable:!0,writable:!0,value:r}):d[l]=r;var a=(d,l,r)=>(J(d,typeof l!="symbol"?l+"":l,r),r);(function(){"use strict";function d(t){var o;const e=(o=t.value)==null?void 0:o.replace("shopify-","").split("-");return{price:e.pop()||"",title:decodeURIComponent(e.join("-"))}}async function l({method:t,address:e}){if(!window.Shopify.Checkout.apiHost)throw new Error("Cannot get Shopify shop");return window.Checkout.jQuery.ajax({type:"POST",url:"/a/outvio/?action=getPoints",dataType:"json",contentType:"application/json",data:JSON.stringify({url:window.Shopify.Checkout.apiHost,method:t,addr:e})})}function r(){const t=window.__oShippingAddress;if(!t||!t.country_code||!t.zip)throw new Error("Cannot get ahipping address");return t}function j(){const t=r();return[t.address1,t.address2,t.city,t.zip,t.country].join(" ")}var s=(t=>(t.pleaseWait="pleaseWait",t.pleaseSelect="pleaseSelect",t.confirmChanges="confirmChanges",t.selectPickupPoint="selectPickupPoint",t))(s||{});const K="",m=function(){let t=null;const e=()=>{var i,c;switch((((c=(i=document.getElementsByTagName("html"))==null?void 0:i[0])==null?void 0:c.lang)||"en").split("-")[0].toLowerCase()){case"es":return{[s.pleaseWait]:"Por favor, espera mientras confirmamos tu pedido...",[s.pleaseSelect]:"Por favor, selecciona tu punto de recogida:",[s.confirmChanges]:"Confirma punto de recogida",[s.selectPickupPoint]:"Selecciona punto de recogida"};case"et":return{[s.pleaseWait]:"Palun oota, kontrollime sinu tellimuse andmeid...",[s.pleaseSelect]:"Palun vali pakiautomaat:",[s.confirmChanges]:"Kinnita pakiautomaat",[s.selectPickupPoint]:"Vali pakiautomaat"};default:return{[s.pleaseWait]:"Please wait while we confirm your order...",[s.pleaseSelect]:"Please select your pickup-point:",[s.confirmChanges]:"Confirm pickup-point",[s.selectPickupPoint]:"Select pickup point"}}};return o=>(t||(t=e()),t[o])}(),z=()=>`
  <div class="outvio-open-modal-section">
    <div class="outvio-selected-point"></div>
    <div class="outvio-btn">
      ${m(s.selectPickupPoint)}
    </div>
  </div>
`,k=t=>`
  <div class="o-point-name">${t.name}</div>
  <div>${t.address}</div>
  <div>${t.city}, ${t.postcode}</div>
`,A=()=>`
  <div class="outvio-modal">
    <div class="outvio-modal-overlay"></div>
    <div class="outvio-modal-section">
      <div class="outvio-content">
        <svg id="outvio-close-modal" xmlns="http://www.w3.org/2000/svg" height="1em" width="1em" viewBox="0 0 48 48" fill="currentColor">
          <path d="M24.05 26.55 13.7 36.9q-.6.6-1.325.6t-1.275-.6q-.6-.55-.6-1.275 0-.725.6-1.275l10.4-10.4-10.45-10.4q-.55-.55-.55-1.275 0-.725.55-1.275.55-.55 1.275-.55.725 0 1.325.55L24 21.35 34.35 11q.55-.55 1.275-.55.725 0 1.325.55.55.6.55 1.35 0 .75-.55 1.3L26.6 24l10.35 10.4q.55.55.55 1.275 0 .725-.55 1.275-.55.55-1.275.55-.725 0-1.225-.55Z"/>
        </svg>
        <h2>${m(s.pleaseSelect)}</h2>
        <div class="outvio-points-select">
          <svg xmlns="http://www.w3.org/2000/svg" height="1em" width="1em"viewBox="0 0 48 48" fill="currentColor">
            <path d="M24 30.55q-.35 0-.675-.15-.325-.15-.575-.45l-9.95-9.9q-.5-.5-.475-1.325.025-.825.525-1.325.6-.6 1.325-.525.725.075 1.275.575l8.55 8.6 8.6-8.6q.5-.5 1.3-.55.8-.05 1.35.55.55.5.5 1.3-.05.8-.55 1.3l-9.9 9.9q-.3.3-.625.45-.325.15-.675.15Z"/>
          </svg>
          <select id="outvio-points-list">
            <option value="all">${m(s.selectPickupPoint)}...</option>
          </select>
        </div>
        <div class="outvio-map-section">
          <div id="outvio-map"></div>
        </div>
        <div class="outvio-modal-actions">
          <div id="outvio-confirm-pickup" class="outvio-btn outvio-dark-btn">
            ${m(s.confirmChanges)}
          </div>
        </div>
      </div>
    </div>
  </div>
`,_="https://bridge.outvio.com";function w(){return window.Checkout.jQuery}const B=["dpd","dhl","glsnew","gls","mrw","omniva","seur","correos","nacex","publiccorreos","sending","venipak","smartpost","ups","mondialrelay","smartpost_new"],T=t=>({icon:{url:`${_}/img/${t}.svg`,scaledSize:new window.google.maps.Size(39,44),origin:new window.google.maps.Point(0,0)}}),S="outvio-pickup-point-selected";class E{constructor(){a(this,"initialized",!1);a(this,"$");a(this,"$modal");a(this,"$root");a(this,"$pointsSelectBox");a(this,"mapIsReady",!1);a(this,"mapInitialized",!1);a(this,"geocoder");a(this,"map");a(this,"icons",new Map);a(this,"points",new Map);a(this,"__selectedPointId","");a(this,"addressMarker");a(this,"currentPoints",[]);a(this,"onSelect",()=>{})}set selectedPointId(e){e==="all"&&(e=""),this.__selectedPointId=e,e?this.$root.addClass(S):this.$root.removeClass(S)}get selectedPointId(){return this.__selectedPointId}init({mapApiKey:e}){const o=w();this.$=o,this.initialized=!0,this.$modal=o(A()),this.$root=o("body"),this.$root.append(this.$modal),this.$modal.find(".outvio-modal-overlay, #outvio-close-modal").on("click",()=>{this.close()}),this.$pointsSelectBox=this.$modal.find("#outvio-points-list"),this.$root.append(o('<script src="https://maps.googleapis.com/maps/api/js?key='+e+'&callback=outvioInitMap"><\/script>')),this.$pointsSelectBox.on("change",()=>{this.onPointSelected(this.$pointsSelectBox.val())}),this.$modal.find("#outvio-confirm-pickup").on("click",()=>{const i=this.getCurrentPoint();i&&(this.onSelect&&this.onSelect(i.data),this.close())})}fucusAddressMarker(){!this.addressMarker||(this.map.panTo(this.addressMarker.position),this.map.setZoom(15))}setMapAddress(e){!this.mapInitialized||this.geocoder.geocode({address:e},(o,i)=>{i==="OK"?(this.addressMarker=new window.google.maps.Marker({map:this.map,position:o[0].geometry.location}),this.fucusAddressMarker()):console.log("Geocode was not successful for the following reason: "+i)})}initMap(){!this.mapIsReady||this.mapInitialized||(this.mapInitialized=!0,this.geocoder=new window.google.maps.Geocoder,this.map=new window.google.maps.Map(document.getElementById("outvio-map"),{center:{lat:-34.397,lng:150.644},zoom:6,disableDefaultUI:!0}),this.setMapAddress(j()),B.forEach(e=>{this.icons.set(e.toUpperCase(),T(e))}))}getPointText(e){return e.city+" > "+e.name}setSelectBoxPoints(e){this.removeSelectBoxPoints(),e.sort((i,c)=>this.getPointText(i)>this.getPointText(c)?1:-1).forEach(i=>{this.$pointsSelectBox.append(this.$(`<option value="${i.id}">${this.getPointText(i)}</option>`))})}removeSelectBoxPoints(){this.$pointsSelectBox.find("option").not('[value="all"]').remove(),this.$pointsSelectBox.val("all")}removeMapPoints(){for(const e of this.points.values())e.marker.setMap(null);this.points=new Map}getCurrentPoint(){return this.selectedPointId?this.points.get(this.selectedPointId):null}unselectPoint(){const e=this.getCurrentPoint();if(!e)return;const o=e.marker.getIcon();o.scaledSize=new window.google.maps.Size(39,44),o.size=new window.google.maps.Size(39,44),e.marker.setIcon(o),e.marker.setZIndex(10)}onPointSelected(e){if(this.selectedPointId&&this.selectedPointId!==e&&this.unselectPoint(),this.selectedPointId=e,e==="all"){this.fucusAddressMarker();return}const o=this.points.get(e);if(!o)return;this.map.panTo(o.position),this.map.setZoom(18),this.$pointsSelectBox.val(e);const i=o.marker.getIcon();i.scaledSize=new window.google.maps.Size(56,64),i.size=new window.google.maps.Size(56,64),o.marker.setIcon(i),o.marker.setZIndex(5e3)}setMapPoints(e){this.removeMapPoints(),e.forEach(o=>{var n;const i=new window.google.maps.LatLng(o.latitude,o.longitude),c=new window.google.maps.Marker({position:i,map:this.map,title:o.name,icon:(n=this.icons.get(o.courier))==null?void 0:n.icon});window.google.maps.event.addListener(c,"click",()=>{this.onPointSelected(o.id)}),this.points.set(o.id,{data:o,marker:c,position:i})})}setPoints(e,o){e!==this.currentPoints&&(this.currentPoints=e,this.onSelect=o,this.selectedPointId="",this.setSelectBoxPoints(e),this.setMapPoints(e))}open(){!this.initialized||(this.mapInitialized||this.initMap(),this.$root.addClass("show-outvio-modal"),setTimeout(()=>{this.$root.addClass("show")},0))}close(){this.$root.removeClass("show"),setTimeout(()=>{this.$root.removeClass("show-outvio-modal")},500)}outvioInitMap(){this.mapIsReady=!0,this.initMap()}}const p=new E;window.outvioInitMap=p.outvioInitMap.bind(p);const q='input[name="checkout[shipping_rate][id]"],input[name^="checkout[delivery_options]["]';function g(){const t=document.querySelectorAll(q);return t!=null&&t.length?Array.from(t).filter(o=>o.name.endsWith("][id]")):[]}function $(t={}){try{Object.keys(t).forEach(e=>O(e,t[e]))}catch(e){console.log("outvio-preserveCartAttributes",e)}}function O(t,e){var i;const o=document.getElementsByName(`checkout[attributes][${t}]`);if(o&&o[0])o[0].setAttribute("value",e);else{const n=g()[0];if(n){let u=document.createElement("input");u.type="hidden",u.name=`checkout[attributes][${t}]`,u.value=e,(i=n.parentNode)==null||i.appendChild(u)}}}function L(t){const e=JSON.stringify(t);return window.Checkout.jQuery.ajax({type:"POST",url:"/cart/update.js",dataType:"json",contentType:"application/json",data:JSON.stringify({attributes:{pickupPoint:e}})}).then(o=>{window.__outvioPickupPoint=e,$(o==null?void 0:o.attributes)})}function N(){return window.Checkout.jQuery.ajax({type:"POST",url:"/cart/update.js",dataType:"json",contentType:"application/json",data:JSON.stringify({attributes:{pickupPoint:null}})}).then(()=>{window.__outvioPickupPoint="",document.querySelectorAll('input[name="checkout[attributes][pickupPoint]"]').forEach(e=>{e.value=""})})}async function Q(t,e){var x;const o=w(),i=d(t),c=r(),n=await l({method:i,address:c}),u=o(t),h=o(z()).hide();if(((x=n==null?void 0:n.points)==null?void 0:x.length)>0){p.initialized||p.init({mapApiKey:n.googleApiKey}),u.closest(".content-box__row").append(h),t.checked&&h.show();const P=h.find(".outvio-selected-point"),W=f=>{P.html(k(f)),L(f)};let y=null;e&&(y=n.points.find(f=>f.id===e),y?P.html(k(y)):e=null),h.find(".outvio-btn").on("click",function(){p.setPoints(n.points,W),p.open(),e&&p.onPointSelected(e)})}t.addEventListener("change",function(){o(".outvio-open-modal-section").hide(),h.show(),(n==null?void 0:n.points)&&(n==null?void 0:n.points.length)<1&&N(),window.__outvioPickupPoint===""&&(e=null,h.find(".outvio-selected-point").empty())})}async function R(){return window.Checkout.jQuery.ajax({type:"GET",url:"/cart.js",dataType:"json",contentType:"application/json"}).then(t=>{var e,o;if(t!=null&&t.attributes)try{if($(t==null?void 0:t.attributes),(e=t==null?void 0:t.attributes)!=null&&e.pickupPoint)return JSON.parse((o=t==null?void 0:t.attributes)==null?void 0:o.pickupPoint).id||null}catch{}return null})}let v=!1,C=0;const b=new MutationObserver(async t=>{for(const e of t)if(e.type==="childList"){const i=g().length;if(i===C)continue;if(C=i,v)return;v=!0,await I(),b.disconnect()}});async function M(){if(v)return;const t=g();if(console.log("<outvio.0.2.0>shipping_rate",t.length),!(t!=null&&t.length)){const e=document.querySelector(".section--shipping-method");e&&b.observe(e,{childList:!0,subtree:!0});return}v=!0,await I()}async function I(){const t=w();t("head").append(t('<link rel="stylesheet" href="https://outvio-prod-public.s3.eu-central-1.amazonaws.com/lib/style.css">'));const o=await R();g().forEach(c=>{try{Q(c,o)}catch(n){console.log("outvio-pickup-points-widget",n)}})}window.Checkout.jQuery(document).on("page:load",M),M()})();
